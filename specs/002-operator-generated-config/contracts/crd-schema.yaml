# CRD Schema Contract: LlamaStackDistribution v1alpha2
#
# This file defines the v1alpha2 spec structure as a reference schema.
# The actual CRD is generated by kubebuilder from Go type definitions.
# This contract is used for validation during design and review.

apiVersion: llamastack.io/v1alpha2
kind: LlamaStackDistribution
metadata:
  name: example
spec:
  # --- Distribution (required, one of name or image) ---
  distribution:
    name: string          # Mapped distribution name (mutually exclusive with image)
    image: string         # Direct container image reference (mutually exclusive with name)

  # --- Providers (optional, mutually exclusive with overrideConfig) ---
  providers:
    inference: ProviderConfigOrList    # Single object or list
    safety: ProviderConfigOrList
    vectorIo: ProviderConfigOrList
    toolRuntime: ProviderConfigOrList
    telemetry: ProviderConfigOrList

  # ProviderConfig schema:
  # - id: string (required when list form; auto-generated for single form)
  # - provider: string (required, maps to provider_type with remote:: prefix)
  # - endpoint: string (optional, maps to config.url)
  # - apiKey: SecretKeyRef (optional, resolved to env var)
  # - settings: map[string]any (optional, escape hatch merged into config)

  # --- Resources (optional, mutually exclusive with overrideConfig) ---
  resources:
    models:               # ModelConfigOrString[]
      - string            # Simple form: model name (uses first inference provider)
      - name: string      # Object form
        provider: string  # Provider ID reference (optional)
        contextLength: int
        modelType: string
        quantization: string
    tools:
      - string            # Tool group names
    shields:
      - string            # Shield names

  # --- Storage (optional, mutually exclusive with overrideConfig) ---
  storage:
    kv:
      type: string        # Enum: sqlite, redis (default: sqlite)
      endpoint: string    # Required for redis
      password:           # SecretKeyRef, optional
        secretKeyRef:
          name: string
          key: string
    sql:
      type: string        # Enum: sqlite, postgres (default: sqlite)
      connectionString:   # SecretKeyRef, required for postgres
        secretKeyRef:
          name: string
          key: string

  # --- Disabled APIs (optional, mutually exclusive with overrideConfig) ---
  disabled:
    - string              # API names to disable (e.g., postTraining, eval)

  # --- Networking (optional) ---
  networking:
    port: int32           # Default: 8321
    tls:
      enabled: bool
      secretName: string  # K8s TLS Secret reference
      caBundle:
        configMapName: string
        configMapNamespace: string  # Optional, defaults to CR namespace
        configMapKeys: [string]     # Optional, defaults to ca-bundle.crt
    expose: ExposeConfig  # Polymorphic: bool or {hostname: string}
    allowedFrom:
      namespaces: [string]
      labels: [string]    # Namespace label keys for NetworkPolicy

  # --- Workload (optional) ---
  workload:
    replicas: int32       # Default: 1
    workers: int32        # Uvicorn worker count
    resources:            # corev1.ResourceRequirements
      requests: {cpu: string, memory: string}
      limits: {cpu: string, memory: string}
    autoscaling:
      minReplicas: int32
      maxReplicas: int32
      targetCPUUtilizationPercentage: int32
      targetMemoryUtilizationPercentage: int32
    storage:              # PVC for persistent data
      size: string        # e.g., "10Gi"
      mountPath: string   # Default: "/.llama"
    podDisruptionBudget:
      minAvailable: IntOrString
      maxUnavailable: IntOrString
    topologySpreadConstraints: []  # corev1.TopologySpreadConstraint
    overrides:
      serviceAccountName: string
      env: []             # corev1.EnvVar
      command: [string]
      args: [string]
      volumes: []         # corev1.Volume
      volumeMounts: []    # corev1.VolumeMount

  # --- External Providers (from spec 001) ---
  externalProviders:
    inference:
      - providerId: string
        image: string

  # --- Override Config (mutually exclusive with providers, resources, storage, disabled) ---
  overrideConfig:
    configMapName: string

# --- CEL Validation Rules ---
# 1. !(has(self.providers) && has(self.overrideConfig))
# 2. !(has(self.resources) && has(self.overrideConfig))
# 3. !(has(self.storage) && has(self.overrideConfig))
# 4. !(has(self.disabled) && has(self.overrideConfig))
# 5. !(has(self.distribution.name) && has(self.distribution.image))
# 6. When providers.<type> is a list, each item must have id
# 7. All provider IDs must be unique across all provider types
